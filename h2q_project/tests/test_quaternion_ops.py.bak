import unittest
import numpy as np
from h2q_project import quaternion_ops

class TestQuaternionOps(unittest.TestCase):

    def test_quaternion_conjugate(self):
        q = np.array([1, 2, 3, 4])
        expected_conjugate = np.array([1, -2, -3, -4])
        np.testing.assert_array_equal(quaternion_ops.quaternion_conjugate(q), expected_conjugate)

    def test_quaternion_multiply(self):
        q1 = np.array([1, 2, 3, 4])
        q2 = np.array([5, 6, 7, 8])
        expected_product = np.array([-60, 12, 30, 24])
        np.testing.assert_array_equal(quaternion_ops.quaternion_multiply(q1, q2), expected_product)

    def test_quaternion_norm(self):
        q = np.array([1, 2, 3, 4])
        expected_norm = np.sqrt(30)
        self.assertAlmostEqual(quaternion_ops.quaternion_norm(q), expected_norm)

    def test_quaternion_normalize(self):
        q = np.array([1, 2, 3, 4])
        expected_normalized = q / np.sqrt(30)
        np.testing.assert_allclose(quaternion_ops.quaternion_normalize(q), expected_normalized)

    def test_quaternion_normalize_zero_norm(self):
        q = np.array([0, 0, 0, 0])
        normalized_q = quaternion_ops.quaternion_normalize(q)
        np.testing.assert_array_equal(normalized_q, q)  # Should return the original quaternion

    def test_quaternion_to_rotation_matrix(self):
        q = np.array([1, 0, 0, 0])  # Identity quaternion
        expected_rotation_matrix = np.eye(3)
        np.testing.assert_allclose(quaternion_ops.quaternion_to_rotation_matrix(q), expected_rotation_matrix)

    def test_numerical_stability(self):
        # Test with large values
        q_large = np.array([1e10, 1e10, 1e10, 1e10])
        quaternion_ops.quaternion_normalize(q_large)
        self.assertTrue(np.all(np.isfinite(quaternion_ops.quaternion_normalize(q_large))))

        # Test with very small values
        q_small = np.array([1e-10, 1e-10, 1e-10, 1e-10])
        quaternion_ops.quaternion_normalize(q_small)
        self.assertTrue(np.all(np.isfinite(quaternion_ops.quaternion_normalize(q_small))))

    def test_accuracy(self):
        # Test quaternion multiplication accuracy
        q1 = np.array([0.7071, 0, 0.7071, 0])  # Rotate 90 degrees around Y axis
        q2 = np.array([0.7071, 0.7071, 0, 0])  # Rotate 90 degrees around X axis
        q_mult = quaternion_ops.quaternion_multiply(q1, q2)
        expected_mult = np.array([0.5, 0.5, 0.5, 0.5])
        np.testing.assert_allclose(q_mult, expected_mult, atol=1e-6)

        # Test quaternion to rotation matrix accuracy
        q = np.array([0.7071, 0, 0.7071, 0]) # Rotate 90 degrees around Y axis
        rotation_matrix = quaternion_ops.quaternion_to_rotation_matrix(q)
        expected_matrix = np.array([
            [0.0, 0.0, 1.0],
            [0.0, 1.0, 0.0],
            [-1.0, 0.0, 0.0]
        ])
        np.testing.assert_allclose(rotation_matrix, expected_matrix, atol=1e-6)


if __name__ == '__main__':
    unittest.main()
