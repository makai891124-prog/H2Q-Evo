import os
import openai

def generate_improvement_suggestion(text_feedback, openai_api_key):
    """Generates improvement suggestions using OpenAI's language model.

    Args:
        text_feedback (str): Text describing the recent training iteration's performance.
        openai_api_key (str): OpenAI API key.

    Returns:
        str: Improvement suggestion generated by the language model, or None if there was an error.
    """
    try:
        openai.api_key = openai_api_key
        response = openai.Completion.create(
            engine="text-davinci-003",  # Or any other suitable engine
            prompt=f"Suggest improvements based on the following feedback: {text_feedback}",
            max_tokens=150,
            n=1,
            stop=None,
            temperature=0.7,
        )

        suggestion = response.choices[0].text.strip()
        return suggestion
    except Exception as e:
        print(f"Error generating improvement suggestion: {e}")
        return None


def log_suggestion(suggestion, log_file="improvement_suggestions.log"):
    """Logs the improvement suggestion to a file.

    Args:
        suggestion (str): The improvement suggestion to log.
        log_file (str): The name of the log file.
    """
    try:
        with open(log_file, "a") as f:
            f.write(suggestion + "\n")
    except Exception as e:
        print(f"Error logging suggestion: {e}")


if __name__ == '__main__':
    # Example usage (replace with your actual feedback and API key)
    feedback = "The model's loss decreased slowly during the last training iteration.  Accuracy on complex shapes is still low."
    openai_api_key = os.environ.get("OPENAI_API_KEY") # Load from environment

    if not openai_api_key:
        print("Error: OPENAI_API_KEY environment variable not set.  Please set it before running.")
    else:
        suggestion = generate_improvement_suggestion(feedback, openai_api_key)

        if suggestion:
            print("Improvement Suggestion:", suggestion)
            log_suggestion(suggestion)
        else:
            print("No suggestion generated.")