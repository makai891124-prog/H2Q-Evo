import docker
import time
import json
import logging
import os

# Configure logging
logging.basicConfig(filename='container_performance.log', level=logging.INFO, 
                    format='%(asctime)s - %(levelname)s - %(message)s')


def monitor_container(container_name):
    try:
        client = docker.from_env()
        container = client.containers.get(container_name)
    except docker.errors.NotFound:
        logging.error(f"Container '{container_name}' not found.")
        return
    except docker.errors.APIError as e:
        logging.error(f"Error connecting to Docker API: {e}")
        return

    while True:
        try:
            stats = container.stats(stream=False)

            cpu_usage = stats['cpu_stats']['cpu_usage']['total_usage']
            system_usage = stats['cpu_stats']['system_cpu_usage']
            cpu_count = len(stats['cpu_stats']['cpu_usage']['percpu_usage'])

            cpu_percent = 0.0
            if system_usage > 0:
                cpu_percent = round(
                    (cpu_usage / system_usage) * cpu_count * 100.0, 2
                )

            memory_usage = stats['memory_stats']['usage']
            memory_limit = stats['memory_stats']['limit']
            memory_percent = round((memory_usage / memory_limit) * 100.0, 2)

            log_data = {
                'container_name': container_name,
                'cpu_percent': cpu_percent,
                'memory_usage': memory_usage,
                'memory_limit': memory_limit,
                'memory_percent': memory_percent
            }

            logging.info(json.dumps(log_data))

            time.sleep(5)

        except docker.errors.APIError as e:
            logging.error(f"Error getting container stats: {e}")
            break
        except Exception as e:
            logging.error(f"An unexpected error occurred: {e}")
            break

if __name__ == "__main__":
    container_name = os.environ.get('CONTAINER_NAME', 'my_container') # Default container name
    monitor_container(container_name)