import torch

def quaternion_conjugate(quaternion: torch.Tensor) -> torch.Tensor:
    """Computes the conjugate of a quaternion.

    Args:
        quaternion: A tensor of shape (..., 4) representing quaternions in (w, x, y, z) format.

    Returns:
        A tensor of the same shape as the input, representing the quaternion conjugates.
    """
    w, x, y, z = torch.unbind(quaternion, dim=-1)
    return torch.stack((w, -x, -y, -z), dim=-1)

def quaternion_multiply(quaternion1: torch.Tensor, quaternion2: torch.Tensor) -> torch.Tensor:
    """Multiplies two quaternions.

    Args:
        quaternion1: A tensor of shape (..., 4) representing the first quaternion in (w, x, y, z) format.
        quaternion2: A tensor of shape (..., 4) representing the second quaternion in (w, x, y, z) format.

    Returns:
        A tensor of the same shape as the inputs, representing the product of the two quaternions.
    """
    w1, x1, y1, z1 = torch.unbind(quaternion1, dim=-1)
    w2, x2, y2, z2 = torch.unbind(quaternion2, dim=-1)

    w = w1 * w2 - x1 * x2 - y1 * y2 - z1 * z2
    x = w1 * x2 + x1 * w2 + y1 * z2 - z1 * y2
    y = w1 * y2 - x1 * z2 + y1 * w2 + z1 * x2
    z = w1 * z2 + x1 * y2 - y1 * x2 + z1 * w2

    return torch.stack((w, x, y, z), dim=-1)

def quaternion_to_rotation_matrix(quaternion: torch.Tensor) -> torch.Tensor:
    """Converts a quaternion to a rotation matrix.

    Args:
        quaternion: A tensor of shape (..., 4) representing quaternions in (w, x, y, z) format.

    Returns:
        A tensor of shape (..., 3, 3) representing the rotation matrices.
    """
    w, x, y, z = torch.unbind(quaternion, dim=-1)
    
    # Normalize the quaternion to ensure it represents a valid rotation
    norm = torch.sqrt(w * w + x * x + y * y + z * z)
    w = w / norm
    x = x / norm
    y = y / norm
    z = z / norm

    tx = 2.0 * x
    ty = 2.0 * y
    tz = 2.0 * z
    twx = tx * w
    twy = ty * w
    twz = tz * w
    txx = tx * x
    txy = ty * x
    txz = tz * x
    tyy = ty * y
    tyz = tz * y
    tzz = tz * z

    matrix = torch.empty(quaternion.shape[:-1] + (3, 3), dtype=quaternion.dtype, device=quaternion.device)
    matrix[..., 0, 0] = 1.0 - (tyy + tzz)
    matrix[..., 0, 1] = txy - twz
    matrix[..., 0, 2] = txz + twy
    matrix[..., 1, 0] = txy + twz
    matrix[..., 1, 1] = 1.0 - (txx + tzz)
    matrix[..., 1, 2] = tyz - twx
    matrix[..., 2, 0] = txz - twy
    matrix[..., 2, 1] = tyz + twx
    matrix[..., 2, 2] = 1.0 - (txx + tyy)

    return matrix
