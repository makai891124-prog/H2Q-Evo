{
  "timestamp": 1769069734.0233521,
  "response": "[\n  {\n    \"file_path\": \"h2q_project/evolution_system.py\",\n    \"content\": \"import os\\nimport subprocess\\nfrom typing import List, Optional\\n\\nfrom h2q_project.utils import count_tokens\\n\\n\\nclass ProjectContextExtractor:\\n    def __init__(self, project_dir: str, max_tokens: int = 4000):\\n        self.project_dir = project_dir\\n        self.max_tokens = max_tokens\\n\\n    def get_relevant_files(self) -> List[str]:\\n        \\\"\\\"\\\"Identifies potentially relevant files for the project context.\\n\\n        This can be expanded to include more sophisticated methods\\n        like analyzing import statements, using a similarity index,\\n        or integrating with a code analysis tool.\\n        \\\"\\\"\\\"\\n        all_files = []\\n        for root, _, files in os.walk(self.project_dir):\\n            for file in files:\\n                if file.endswith(('.py', '.txt', '.md')):\\n                    all_files.append(os.path.join(root, file))\\n        return all_files\\n\\n    def read_file_content(self, file_path: str) -> str:\\n        \\\"\\\"\\\"Reads the content of a file.\\n        \\\"\\\"\\\"\\n        try:\\n            with open(file_path, 'r', encoding='utf-8') as f:\\n                return f.read()\\n        except Exception as e:\\n            print(f\\\"Error reading file {file_path}: {e}\\\")\\n            return \\\"\\\"\\n\\n    def get_project_context(self) -> str:\\n        \\\"\\\"\\\"Extracts project context information from relevant files.\\n\\n        Includes file paths and content, truncated to fit within the token limit.\\n        \\\"\\\"\\\"\\n        context = \\\"\\\"\\n        relevant_files = self.get_relevant_files()\\n\\n        for file_path in relevant_files:\\n            relative_path = os.path.relpath(file_path, self.project_dir)\\n            file_content = self.read_file_content(file_path)\\n            file_context = f\\\"\\\\nFile: {relative_path}\\\\n{file_content}\\\\n\\\"\\n\\n            if count_tokens(context + file_context) > self.max_tokens:\\n                print(f\\\"Truncating file {relative_path} due to token limit.\\\")\\n                truncated_content = self.truncate_content(file_content, self.max_tokens - count_tokens(context) - count_tokens(f\\\"\\\\nFile: {relative_path}\\\\n...\\\"))\\n                file_context = f\\\"\\\\nFile: {relative_path}\\\\n{truncated_content}\\\\n\\\"\\n                if count_tokens(context + file_context) > self.max_tokens: # Double check after truncation\\n                    break # even truncation fails, discard the file\\n\\n            context += file_context\\n\\n        return context\\n\\n    def truncate_content(self, content: str, max_tokens: int) -> str:\\n        \\\"\\\"\\\"Truncates content to fit within the token limit.\\n        \\\"\\\"\\\"\\n        if count_tokens(content) <= max_tokens:\\n            return content\\n\\n        truncated_content = \\\"\\\"\\n        words = content.split()\\n        for word in words:\\n            if count_tokens(truncated_content + word) <= max_tokens:\\n                truncated_content += word + \\\" \\\"\\n            else:\\n                break\\n        return truncated_content + \\\"... (truncated)\\\"\\n\\n\\n\\nclass GitProjectContextExtractor(ProjectContextExtractor):\\n    def __init__(self, project_dir: str, max_tokens: int = 4000):\\n        super().__init__(project_dir, max_tokens)\\n\\n    def get_relevant_files(self) -> List[str]:\\n        \\\"\\\"\\\"Uses git to identify tracked files as relevant.\\n        \\\"\\\"\\\"\\n        try:\\n            result = subprocess.run(\\n                ['git', 'ls-tree', '-r', 'HEAD', '--name-only'],\\n                cwd=self.project_dir,\\n                capture_output=True,\\n                text=True,\\n                check=True\\n            )\\n            filepaths = result.stdout.splitlines()\\n            # Create absolute paths by joining with the project directory\\n            absolute_filepaths = [os.path.join(self.project_dir, filepath) for filepath in filepaths]\\n            return absolute_filepaths\\n        except subprocess.CalledProcessError as e:\\n            print(f\\\"Error running git ls-tree: {e}\\\")\\n            # If git fails, fall back to the basic file listing.\\n            return super().get_relevant_files()\\n\\n\\ndef get_project_context(\\n    project_dir: str, max_tokens: int = 4000, use_git: bool = False\\n) -> str:\\n    \\\"\\\"\\\"Helper function to extract project context, choosing the appropriate extractor.\\n    \\\"\\\"\\\"\\n    if use_git:\\n        extractor = GitProjectContextExtractor(project_dir, max_tokens)\\n    else:\\n        extractor = ProjectContextExtractor(project_dir, max_tokens)\\n\\n    return extractor.get_project_context()\\n\"\n  }\n]",
  "model": "gemini-2.0-flash"
}